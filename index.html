<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>cabi Invitation Studio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #ffffff; }
    .card {
      background: #ffffff;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 10px 36px rgba(17, 24, 39, 0.08);
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    .field {
      background: #fff;
      font-size: 1.05rem;
      line-height: 1.6;
      padding: 0.9rem 1rem;
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 0 rgba(17,24,39,0.02) inset;
      width: 100%;
    }
    .field:focus {
      outline: none;
      border-color: #0f172a;
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.12);
    }
  </style>
</head>
<body class="text-slate-800">
  <header class="max-w-6xl mx-auto px-4 md:px-8 pt-10 pb-4">
    <div class="flex items-center gap-4">
      <svg width="32" height="20" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"
           class="text-slate-700" aria-hidden="true">
        <path d="M12 3a3 3 0 0 1 3 3c0 1.5-1 2-2.1 2.6-.6.3-.9.8-.9 1.4v.5" />
        <path d="M3.5 18.5 12 13l8.5 5.5" />
        <path d="M4 19h16" />
      </svg>
      <div>
        <h1 class="text-3xl md:text-4xl font-semibold tracking-tight">cabi Invitation Studio</h1>
        <p class="text-slate-600 mt-2 text-lg">Type your tone & collection or put everything in the box.</p>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 md:px-8 pb-20">
    <div class="grid lg:grid-cols-2 gap-8">
      <!-- Form -->
      <section class="card p-8">
        <h2 class="text-xl font-semibold mb-6">Details</h2>
        <form id="inviteForm" class="space-y-6" novalidate>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <label class="block">
              <span class="text-sm text-slate-700">Invitee Name</span>
              <input name="name" class="field mt-2" placeholder="Mary Jane" autocomplete="off"/>
            </label>
            <label class="block">
              <span class="text-sm text-slate-700">Event</span>
              <input name="event" class="field mt-2" placeholder="Wardrobe refresh" autocomplete="off"/>
            </label>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <label class="block">
              <span class="text-sm text-slate-700">Tone</span>
              <input name="tone" list="toneList" class="field mt-2" placeholder="Warm & Polished" autocomplete="off"/>
              <datalist id="toneList">
                <option value="Warm & Polished"></option>
                <option value="Playful & Fun"></option>
                <option value="Elevated & Elegant"></option>
                <option value="Casual & Friendly"></option>
                <option value="Luxe Concierge"></option>
                <option value="Minimal & Modern"></option>
                <option value="Bold & Joyful"></option>
                <option value="Romantic & Chic"></option>
                <option value="Laid-Back & Conversational"></option>
                <option value="VIP Personal Stylist"></option>
              </datalist>
            </label>

            <label class="block">
              <span class="text-sm text-slate-700">Collection</span>
              <input name="collection" list="collectionList" class="field mt-2" placeholder="Tailored Touch" autocomplete="off"/>
              <datalist id="collectionList">
                <option value="Spring Edit"></option>
                <option value="Summer Edit"></option>
                <option value="Fall Edit"></option>
                <option value="Holiday Edit"></option>
                <option value="Just In"></option>
                <option value="Everyday Essentials"></option>
              </datalist>
            </label>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <label class="block">
              <span class="text-sm text-slate-700">Stylist Name</span>
              <input name="stylist" class="field mt-2" placeholder="Your cabi Stylist" autocomplete="off"/>
            </label>
            <label class="block">
              <span class="text-sm text-slate-700">Style Interests</span>
              <input name="style_interest" class="field mt-2" placeholder="versatile pieces, polished essentials" autocomplete="off"/>
            </label>
          </div>

          <div class="flex items-center gap-3 my-2" aria-hidden="true">
            <div class="h-px flex-1 bg-slate-200"></div>
            <span class="text-xs uppercase tracking-wider text-slate-500">Or</span>
            <div class="h-px flex-1 bg-slate-200"></div>
          </div>
          <p class="text-sm text-slate-600 -mt-2 mb-2">
            Either fill the fields above <strong>or</strong> type all details in the box below.
            If both are provided, the box will be used.
          </p>

          <!-- Everything box -->
          <div class="space-y-2">
            <label class="block">
              <span class="text-sm text-slate-700">Everything Box (optional)</span>
              <textarea id="brief" name="brief" class="field mt-2" style="min-height: 180px;"
                placeholder="Type everything here if you prefer:"></textarea>
            </label>
          </div>

          <button class="w-full mt-2 rounded-2xl bg-slate-900 hover:bg-slate-800 text-white text-lg font-medium px-5 py-4 transition">
            Generate Invitation
          </button>
        </form>
      </section>

      <!-- Output -->
      <section class="card p-8">
        <h2 class="text-xl font-semibold mb-6">Result</h2>
        <div id="status" class="text-sm text-slate-600 mb-3">Fill the form or the box, then click Generate.</div>
        <pre id="output" class="mono whitespace-pre-wrap bg-slate-50 rounded-xl p-5 min-h-[360px] ring-1 ring-slate-200 text-[0.98rem]"></pre>
        <div class="flex flex-wrap gap-4 mt-5">
          <button id="copyAll" class="rounded-xl bg-white hover:bg-slate-50 px-5 py-2.5 ring-1 ring-slate-200">Copy All</button>
          <button id="copySubject" class="rounded-xl bg-white hover:bg-slate-50 px-5 py-2.5 ring-1 ring-slate-200">Copy Subject</button>
          <button id="copyBody" class="rounded-xl bg-white hover:bg-slate-50 px-5 py-2.5 ring-1 ring-slate-200">Copy Body</button>
        </div>
      </section>
    </div>
  </main>

  <footer class="max-w-6xl mx-auto px-4 md:px-8 pb-10 text-slate-600 text-sm">
    <p>Use the Everything Box for one-paragraph briefs. The app will expand and format it.</p>
  </footer>

<script>
  const FORM = document.getElementById('inviteForm');
  const OUT  = document.getElementById('output');
  const ST   = document.getElementById('status');

  // Replace this with your Pipedream HTTP trigger URL
  let ENDPOINT = "https://eo8jd6zy8myq6dm.m.pipedream.net";

  // Allow ?endpoint=URL override for quick testing
  try {
    const u = new URL(location.href);
    const qp = u.searchParams.get("endpoint");
    if (qp) ENDPOINT = qp;
  } catch {}

 function requireEndpoint() {
   if (!ENDPOINT) {
     ST.textContent = "Missing endpoint.";
     return false;
   }
   return true;
 }


  FORM.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!requireEndpoint()) return;

    ST.textContent = "Generating…";
    OUT.textContent = "";

    const form = new FormData(FORM);
    const payload = Object.fromEntries(form.entries());

    try {
      const res = await fetch(ENDPOINT, {
        method: 'POST',
        mode: 'cors',
        cache: 'no-store',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(payload),
      });

      const raw = await res.text();
      let data = {};
      try { data = JSON.parse(raw); } catch { /* not JSON -> maybe HTML (405 page) */ }

      // Handle explicit 405
      if (res.status === 405) {
        ST.textContent = "405 Not Allowed";
        OUT.textContent =
`Your endpoint rejected POST (405).
• Make sure you used the Pipedream "HTTP / Webhook" trigger URL (not a display page).
• The URL should look like https://xxxxx.m.pipedream.net
• Your backend must accept POST (and OPTIONS for preflight).`;
        return;
      }

      // Graceful handling: always render nice "Subject + Body"
      let invite = "";
      if (data && typeof data.invitation === "string" && data.invitation.trim()) {
        invite = data.invitation.trim();
      } else if (data && typeof data.subject === "string" && typeof data.body === "string") {
        invite = `Subject: ${data.subject.trim()}\n\n${data.body.trim()}`;
      } else {
        // Salvage from raw JSON-ish or HTML
        const subMatch  = raw.match(/"subject"\s*:\s*"([^"]+)"/i);
        const bodyMatch = raw.match(/"body"\s*:\s*"([\s\S]*?)"\s*[,}]/i);
        if (subMatch && bodyMatch) {
          const sub  = subMatch[1];
          const body = bodyMatch[1].replace(/\\"/g, '"');
          invite = `Subject: ${sub}\n\n${body}`;
        } else if (/^\s*</.test(raw)) {
          // Looks like HTML (e.g., 405 page)
          invite = "";
          ST.textContent = "Unexpected HTML from server";
          OUT.textContent = "The server returned an HTML page. Confirm the endpoint is correct and supports POST.";
          return;
        }
      }

      if (invite) {
        ST.textContent = "Done";
        OUT.textContent = invite; // no braces, always pretty
      } else if (data && data.error) {
        ST.textContent = "Error";
        OUT.textContent = String(data.error);
      } else {
        ST.textContent = "Unexpected response";
        OUT.textContent = raw || "(empty)";
      }

    } catch (err) {
      ST.textContent = "Network error";
      OUT.textContent = String(err);
    }
  });

  // Copy helpers
  function copy(text) {
    if (!text) return;
    navigator.clipboard.writeText(text).then(() => {
      ST.textContent = "Copied!";
      setTimeout(() => ST.textContent = "Ready", 900);
    });
  }
  document.getElementById('copyAll').onclick = () => copy(OUT.textContent || "");
  document.getElementById('copySubject').onclick = () => {
    const m = (OUT.textContent || "").match(/^Subject:\s*(.+)$/m);
    copy(m ? m[1] : "");
  };
  document.getElementById('copyBody').onclick = () => {
    const lines = (OUT.textContent || "").split("\n");
    const iStart = lines.findIndex(l => l.startsWith("Subject:")) + 2;
    copy(lines.slice(iStart).join("\n"));
  };
</script>
</body>
</html>
